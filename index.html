<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">
    <title>Alpha Facilities</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ============================================
        // CAMERA FUNCTIONS (Global)
        // ============================================
        let cameraStream = null;
        let cameraCallback = null;

        async function openCamera(callback, label = 'Take Photo') {
            cameraCallback = callback;
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraFeed');
            const labelEl = document.getElementById('cameraLabel');
            
            if (labelEl) labelEl.textContent = 'üì∑ ' + label;
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false
                });
                video.srcObject = cameraStream;
                modal.classList.remove('hidden');
            } catch (err) {
                alert('Unable to access camera. Please grant permission and try again.');
                console.error('Camera error:', err);
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('cameraCanvas');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            closeCamera();
            
            if (cameraCallback) {
                cameraCallback(imageData);
                cameraCallback = null;
            }
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraFeed');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            video.srcObject = null;
            modal.classList.add('hidden');
            cameraCallback = null;
        }

        // ============================================
        // CONFIGURATION
        // ============================================
        const CAMPUSES = [
            "Alpha Austin",
            "Alpha Dallas",
            "Alpha Houston",
            "Alpha San Francisco",
            "Alpha Phoenix",
            "Alpha Denver"
        ];

        const ISSUE_CATEGORIES = [
            { id: 'cleaning', name: 'Cleaning Issue', icon: 'üßπ', team: 'Housekeeping' },
            { id: 'supplies', name: 'Supplies Empty', icon: 'üßª', team: 'Housekeeping' },
            { id: 'spill', name: 'Spill / Wet Floor', icon: 'üíß', team: 'Housekeeping' },
            { id: 'trash', name: 'Trash Overflow', icon: 'üóëÔ∏è', team: 'Housekeeping' },
            { id: 'odor', name: 'Odor Issue', icon: 'üëÉ', team: 'Housekeeping' },
            { id: 'plumbing', name: 'Plumbing', icon: 'üöø', team: 'B&G' },
            { id: 'electrical', name: 'Electrical', icon: '‚ö°', team: 'B&G' },
            { id: 'hvac', name: 'HVAC / Temperature', icon: '‚ùÑÔ∏è', team: 'B&G' },
            { id: 'damage', name: 'Building Damage', icon: 'üî®', team: 'B&G' },
            { id: 'safety', name: 'Safety Hazard', icon: '‚ö†Ô∏è', team: 'Facilities Manager' },
            { id: 'pest', name: 'Pest Issue', icon: 'üêõ', team: 'Vendor' },
            { id: 'other', name: 'Other', icon: '‚ùì', team: 'Facilities Manager' }
        ];

        const ZONES = {
            entry: {
                name: "Entry & Lobby",
                type: "mandatory",
                amberEligible: true,
                description: "Parent-facing zone ‚Äî 47-second arrival decision",
                cleanliness: [
                    "Floor free of debris, spills, and stains?",
                    "Entry mat clean and flat (no trip hazard)?",
                    "Exterior door glass smudge-free?",
                    "Interior glass smudge-free?",
                    "Reception surfaces dust-free?",
                    "High-touch surfaces clean (door handles, counter)?",
                    "Trash cans empty with liners intact?",
                    "No detectable odor from doorway?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            hallway: {
                name: "Hallway / Corridor",
                type: "mandatory",
                amberEligible: true,
                cleanliness: [
                    "Floor free of debris, spills, and stains?",
                    "Edges, corners, and baseboards dust-free?",
                    "No visible scuff marks on walls?",
                    "Glass and doors smudge-free?",
                    "High-touch surfaces clean (door handles, railings)?",
                    "Trash cans empty with liners intact?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            restroom_primary: {
                name: "Restroom (Lobby / Primary)",
                type: "mandatory",
                amberEligible: false,
                description: "Amber-Ineligible zone ‚Äî any defect = Red",
                cleanliness: [
                    "Toilets/urinals sanitary (no visible soil, stains, residue)?",
                    "Sinks and counters dry and clean?",
                    "Mirrors smudge-free?",
                    "Floor free of debris, water, and stains?",
                    "Soap dispensers functional and stocked?",
                    "Paper towels/hand dryers functional and stocked?",
                    "Toilet paper stocked (not empty)?",
                    "Trash cans empty with liners intact?",
                    "No detectable odor from doorway?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            commons: {
                name: "Commons Area",
                type: "mandatory",
                amberEligible: true,
                cleanliness: [
                    "Floor free of debris, spills, and stains?",
                    "Tables and surfaces clean and dry?",
                    "Furniture properly arranged (not scattered)?",
                    "High-touch surfaces clean?",
                    "Trash cans empty with liners intact?",
                    "No detectable odor?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            supply_closet: {
                name: "Supply Closet",
                type: "mandatory",
                amberEligible: true,
                description: "Inventory verification ‚Äî 1-week minimum threshold",
                isSupplyCheck: true,
                cleanliness: [
                    "Toilet paper: 1-week supply available?",
                    "Paper towels: 1-week supply available?",
                    "Soap/sanitizer: 1-week supply available?",
                    "Trash liners: 1-week supply available?",
                    "Cleaning supplies present and stocked?",
                    "Closet organized (not cluttered/hazardous)?"
                ],
                supplyItems: [0, 1, 2, 3]
            },
            restroom_additional: {
                name: "Restroom (Additional)",
                type: "optional",
                amberEligible: false,
                description: "Amber-Ineligible zone ‚Äî any defect = Red",
                cleanliness: [
                    "Toilets/urinals sanitary?",
                    "Sinks and counters dry and clean?",
                    "Mirrors smudge-free?",
                    "Floor free of debris, water, and stains?",
                    "Soap dispensers functional and stocked?",
                    "Paper towels/hand dryers functional and stocked?",
                    "Toilet paper stocked?",
                    "Trash cans empty with liners intact?",
                    "No detectable odor from doorway?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            classroom: {
                name: "Classroom",
                type: "optional",
                amberEligible: true,
                cleanliness: [
                    "Floor free of debris, spills, and stains?",
                    "Edges, corners, and baseboards dust-free?",
                    "Student desks/tables clean?",
                    "Teacher desk/surfaces clean?",
                    "Whiteboard/board area clean (tray, ledge)?",
                    "High-touch surfaces clean (door handle, light switches)?",
                    "Trash cans empty with liners intact?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            office: {
                name: "Office / Workroom",
                type: "optional",
                amberEligible: true,
                cleanliness: [
                    "Floor free of debris and stains?",
                    "Desk and work surfaces dust-free?",
                    "High-touch surfaces clean?",
                    "Trash cans empty with liners intact?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            gym: {
                name: "Gym / Multi-Purpose",
                type: "optional",
                amberEligible: true,
                cleanliness: [
                    "Floor free of debris, spills, and stains?",
                    "Floor finish intact (no excessive scuffing/peeling)?",
                    "Bleachers/seating clean?",
                    "Equipment storage area organized?",
                    "High-touch surfaces clean (door handles, equipment)?",
                    "Trash cans empty with liners intact?",
                    "No detectable odor?",
                    "All clear ‚Äî no safety hazards?"
                ]
            },
            cafeteria: {
                name: "Cafeteria",
                type: "optional",
                amberEligible: true,
                cleanliness: [
                    "Floor free of debris, spills, and stains?",
                    "Tables and seating clean and dry?",
                    "Service/counter area clean?",
                    "High-touch surfaces clean?",
                    "Trash cans empty with liners intact?",
                    "No detectable odor?",
                    "All clear ‚Äî no safety hazards?"
                ]
            }
        };

        const MANDATORY_ZONE_IDS = ['entry', 'hallway', 'restroom_primary', 'commons', 'supply_closet'];
        const OPTIONAL_ZONE_IDS = ['restroom_additional', 'classroom', 'office', 'gym', 'cafeteria'];

        // ============================================
        // APP STATE
        // ============================================
        let state = {
            screen: 'home',
            // QC Audit state
            campus: '',
            auditorName: '',
            startTime: null,
            selectedOptionalZones: [],
            currentZoneIndex: 0,
            zoneResults: {},
            conditionAlerts: [],
            tourReady: null,
            // See It Report It state
            reportCampus: '',
            reportPhoto: null,
            reportCategory: null,
            reportLocation: '',
            reportNote: '',
            reportUrgent: false
        };

        // ============================================
        // STORAGE
        // ============================================
        function saveAudit(audit) {
            const audits = JSON.parse(localStorage.getItem('alpha_audits') || '[]');
            audits.push(audit);
            localStorage.setItem('alpha_audits', JSON.stringify(audits));
        }

        function getAudits() {
            return JSON.parse(localStorage.getItem('alpha_audits') || '[]');
        }

        function saveReport(report) {
            const reports = JSON.parse(localStorage.getItem('alpha_reports') || '[]');
            reports.push(report);
            localStorage.setItem('alpha_reports', JSON.stringify(reports));
        }

        function getReports() {
            return JSON.parse(localStorage.getItem('alpha_reports') || '[]');
        }

        // ============================================
        // STATUS CALCULATION
        // ============================================
        function calculateStatus() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            let totalDefects = 0;
            let hasAmberIneligibleDefect = false;

            for (const zoneId of allZones) {
                const zone = ZONES[zoneId];
                const results = state.zoneResults[zoneId] || {};
                const defects = Object.values(results).filter(v => v === 'no').length;
                totalDefects += defects;
                if (!zone.amberEligible && defects > 0) {
                    hasAmberIneligibleDefect = true;
                }
            }

            if (state.tourReady === 'no') return 'RED';
            if (hasAmberIneligibleDefect) return 'RED';
            if (totalDefects === 0) return 'GREEN';
            if (totalDefects === 1) return 'AMBER';
            return 'RED';
        }

        function countDefects(zoneId) {
            const results = state.zoneResults[zoneId] || {};
            return Object.values(results).filter(v => v === 'no').length;
        }

        function getTotalDefects() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            return allZones.reduce((sum, zoneId) => sum + countDefects(zoneId), 0);
        }

        // ============================================
        // RENDER
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            switch(state.screen) {
                case 'home': app.innerHTML = renderHome(); break;
                case 'setup': app.innerHTML = renderSetup(); break;
                case 'audit': app.innerHTML = renderAuditOverview(); break;
                case 'zone': app.innerHTML = renderZone(); break;
                case 'condition': app.innerHTML = renderConditionAlert(); break;
                case 'tourready': app.innerHTML = renderTourReady(); break;
                case 'summary': app.innerHTML = renderSummary(); break;
                case 'complete': app.innerHTML = renderComplete(); break;
                case 'history': app.innerHTML = renderHistory(); break;
                case 'report_start': app.innerHTML = renderReportStart(); break;
                case 'report_photo': app.innerHTML = renderReportPhoto(); break;
                case 'report_details': app.innerHTML = renderReportDetails(); break;
                case 'report_complete': app.innerHTML = renderReportComplete(); break;
                case 'reports_list': app.innerHTML = renderReportsList(); break;
            }
            
            attachEventListeners();
        }

        function renderHome() {
            const audits = getAudits();
            const reports = getReports();
            const openReports = reports.filter(r => r.status === 'open').length;
            
            return `
                <div class="min-h-screen bg-gradient-to-b from-blue-800 to-blue-900 text-white">
                    <div class="p-6 pt-12">
                        <h1 class="text-3xl font-bold mb-1">Alpha Facilities</h1>
                        <p class="text-blue-200">Cleanliness & Issue Management</p>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <!-- See It Report It -->
                        <button onclick="startReport()" class="w-full bg-red-500 text-white py-4 rounded-xl text-lg font-bold shadow-lg flex items-center justify-center">
                            <span class="text-2xl mr-3">üì∏</span>
                            See It, Report It
                        </button>
                        
                        <!-- Daily QC -->
                        <button onclick="startAudit()" class="w-full bg-white text-blue-800 py-4 rounded-xl text-lg font-bold shadow-lg flex items-center justify-center">
                            <span class="text-2xl mr-3">‚úÖ</span>
                            Daily QC Walkthrough
                        </button>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 gap-3 mt-6">
                            <button onclick="goToHistory()" class="bg-blue-700/50 p-4 rounded-xl text-left">
                                <div class="text-3xl font-bold">${audits.length}</div>
                                <div class="text-blue-200 text-sm">QC Audits</div>
                            </button>
                            <button onclick="goToReportsList()" class="bg-blue-700/50 p-4 rounded-xl text-left">
                                <div class="text-3xl font-bold">${reports.length}</div>
                                <div class="text-blue-200 text-sm">Issues Reported</div>
                                ${openReports > 0 ? `<div class="text-yellow-300 text-xs mt-1">${openReports} open</div>` : ''}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="bg-white text-gray-800 rounded-t-3xl mt-4 p-6 min-h-[250px]">
                        <h2 class="font-bold text-lg mb-4">Recent Activity</h2>
                        ${renderRecentActivity(audits, reports)}
                    </div>
                </div>
            `;
        }

        function renderRecentActivity(audits, reports) {
            const combined = [
                ...audits.map(a => ({ ...a, type: 'audit', sortDate: new Date(a.date + ' ' + a.time) })),
                ...reports.map(r => ({ ...r, type: 'report', sortDate: new Date(r.timestamp) }))
            ].sort((a, b) => b.sortDate - a.sortDate).slice(0, 5);

            if (combined.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üìã</div>
                        <p>No activity yet</p>
                    </div>
                `;
            }

            return `
                <div class="space-y-3">
                    ${combined.map(item => {
                        if (item.type === 'audit') {
                            return `
                                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="text-2xl mr-3">${item.status === 'GREEN' ? 'üü¢' : item.status === 'AMBER' ? 'üü°' : 'üî¥'}</span>
                                    <div class="flex-1">
                                        <div class="font-medium">QC: ${item.campus}</div>
                                        <div class="text-sm text-gray-500">${item.date} ‚Ä¢ ${item.defects} defect${item.defects !== 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            const cat = ISSUE_CATEGORIES.find(c => c.id === item.category) || { icon: '‚ùì', name: 'Issue' };
                            return `
                                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="text-2xl mr-3">${cat.icon}</span>
                                    <div class="flex-1">
                                        <div class="font-medium">${cat.name}</div>
                                        <div class="text-sm text-gray-500">${item.campus} ‚Ä¢ ${item.location || 'No location'}</div>
                                    </div>
                                    <span class="text-xs px-2 py-1 rounded ${item.status === 'open' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${item.status}</span>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }

        // ============================================
        // SEE IT REPORT IT SCREENS
        // ============================================
        function renderReportStart() {
            return `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-red-500 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="goHome()" class="text-2xl mr-3">‚Üê</button>
                            <div>
                                <h1 class="text-xl font-bold">See It, Report It</h1>
                                <p class="text-red-100 text-sm">Report a facility issue</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <div class="bg-white rounded-lg p-6 shadow text-center">
                            <div class="text-6xl mb-4">üì∏</div>
                            <h2 class="text-xl font-bold mb-2">Snap a Photo</h2>
                            <p class="text-gray-600 mb-6">Take a photo of the issue. It will be automatically analyzed and routed to the right team.</p>
                            
                            <div class="space-y-3 mb-6">
                                <label class="block text-left text-sm font-medium text-gray-700">Campus *</label>
                                <select id="reportCampus" class="w-full border border-gray-300 rounded-lg p-3 text-lg bg-white">
                                    <option value="">Select campus...</option>
                                    ${CAMPUSES.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            
                            <button onclick="openReportCamera()" class="w-full bg-red-500 text-white py-4 rounded-xl text-lg font-bold">
                                üì∑ Open Camera
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-sm text-blue-800">
                                <strong>How it works:</strong><br>
                                1. Take a photo of the issue<br>
                                2. Select category and add details<br>
                                3. Submit ‚Äî right team gets notified
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReportPhoto() {
            return `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-red-500 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="state.screen='report_start'; render();" class="text-2xl mr-3">‚Üê</button>
                            <div>
                                <h1 class="text-xl font-bold">Review Photo</h1>
                                <p class="text-red-100 text-sm">${state.reportCampus}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        ${state.reportPhoto ? `
                            <div class="rounded-lg overflow-hidden shadow">
                                <img src="${state.reportPhoto}" alt="Issue photo" class="w-full">
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="retakePhoto()" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium">
                                    üîÑ Retake
                                </button>
                                <button onclick="state.screen='report_details'; render();" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-medium">
                                    Continue ‚Üí
                                </button>
                            </div>
                        ` : `
                            <div class="bg-white rounded-lg p-12 text-center text-gray-400">
                                <div class="text-6xl mb-4">üì∑</div>
                                <p>No photo captured</p>
                                <button onclick="openReportCamera()" class="mt-4 bg-red-500 text-white px-6 py-2 rounded-lg">
                                    Open Camera
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderReportDetails() {
            return `
                <div class="min-h-screen bg-gray-100 pb-24">
                    <div class="bg-red-500 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="state.screen='report_photo'; render();" class="text-2xl mr-3">‚Üê</button>
                            <div>
                                <h1 class="text-xl font-bold">Issue Details</h1>
                                <p class="text-red-100 text-sm">${state.reportCampus}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <!-- Photo thumbnail -->
                        ${state.reportPhoto ? `
                            <div class="flex items-center bg-white rounded-lg p-3 shadow">
                                <img src="${state.reportPhoto}" alt="Issue" class="w-16 h-16 object-cover rounded mr-3">
                                <div class="text-sm text-gray-600">Photo captured ‚úì</div>
                            </div>
                        ` : ''}
                        
                        <!-- Category Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">What type of issue? *</label>
                            <div class="grid grid-cols-3 gap-2">
                                ${ISSUE_CATEGORIES.map(cat => `
                                    <button onclick="setReportCategory('${cat.id}')" class="p-3 rounded-lg border-2 text-center ${state.reportCategory === cat.id ? 'border-red-500 bg-red-50' : 'border-gray-200 bg-white'}">
                                        <div class="text-2xl mb-1">${cat.icon}</div>
                                        <div class="text-xs">${cat.name}</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Location -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location *</label>
                            <input type="text" id="reportLocation" value="${state.reportLocation}" placeholder="e.g., 2nd floor restroom, Room 204, Main hallway" class="w-full border border-gray-300 rounded-lg p-3">
                        </div>
                        
                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (optional)</label>
                            <textarea id="reportNote" placeholder="Any additional details..." class="w-full border border-gray-300 rounded-lg p-3" rows="2">${state.reportNote}</textarea>
                        </div>
                        
                        <!-- Urgent toggle -->
                        <div class="bg-white rounded-lg p-4 shadow">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="reportUrgent" ${state.reportUrgent ? 'checked' : ''} class="sr-only">
                                <div class="w-12 h-6 rounded-full mr-3 ${state.reportUrgent ? 'bg-red-500' : 'bg-gray-300'}" onclick="toggleUrgent()">
                                    <div class="w-5 h-5 bg-white rounded-full shadow transform transition-transform ${state.reportUrgent ? 'translate-x-6' : 'translate-x-1'}" style="margin-top: 2px;"></div>
                                </div>
                                <div>
                                    <div class="font-medium">üö® Urgent / Safety Hazard</div>
                                    <div class="text-sm text-gray-500">Requires immediate attention</div>
                                </div>
                            </label>
                        </div>
                        
                        ${state.reportCategory ? `
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-600">
                                    <strong>Routes to:</strong> ${ISSUE_CATEGORIES.find(c => c.id === state.reportCategory)?.team || 'Facilities'}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                        <button onclick="submitReport()" class="w-full py-4 rounded-xl text-lg font-bold ${canSubmitReport() ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-500'}" ${canSubmitReport() ? '' : 'disabled'}>
                            ${state.reportUrgent ? 'üö® Submit Urgent Report' : '‚úì Submit Report'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderReportComplete() {
            const cat = ISSUE_CATEGORIES.find(c => c.id === state.reportCategory);
            return `
                <div class="min-h-screen bg-green-500 flex flex-col items-center justify-center p-8 text-white text-center">
                    <div class="text-8xl mb-6">‚úÖ</div>
                    <h1 class="text-3xl font-bold mb-2">Report Submitted!</h1>
                    <p class="text-lg opacity-90 mb-4">${cat?.team || 'Facilities'} has been notified</p>
                    
                    <div class="bg-white/20 rounded-lg p-4 mb-8 w-full max-w-sm text-left">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">${cat?.icon || 'üìã'}</span>
                            <span class="font-bold">${cat?.name || 'Issue'}</span>
                        </div>
                        <div class="text-sm opacity-90">${state.reportCampus}</div>
                        <div class="text-sm opacity-90">${state.reportLocation}</div>
                    </div>
                    
                    <button onclick="goHome()" class="bg-white text-green-600 px-8 py-3 rounded-lg font-bold">
                        Done
                    </button>
                </div>
            `;
        }

        function renderReportsList() {
            const reports = getReports().reverse();
            return `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-red-500 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="goHome()" class="text-2xl mr-3">‚Üê</button>
                            <h1 class="text-xl font-bold">Reported Issues</h1>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        ${reports.length === 0 ? `
                            <div class="text-center py-12 text-gray-400">
                                <div class="text-5xl mb-4">üì∏</div>
                                <p>No issues reported yet</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${reports.map(r => {
                                    const cat = ISSUE_CATEGORIES.find(c => c.id === r.category) || { icon: '‚ùì', name: 'Issue' };
                                    return `
                                        <div class="bg-white rounded-lg p-4 shadow">
                                            <div class="flex items-start">
                                                ${r.photo ? `<img src="${r.photo}" alt="Issue" class="w-16 h-16 object-cover rounded mr-3">` : ''}
                                                <div class="flex-1">
                                                    <div class="flex items-center justify-between mb-1">
                                                        <span class="font-bold flex items-center">
                                                            <span class="mr-2">${cat.icon}</span>
                                                            ${cat.name}
                                                        </span>
                                                        <span class="text-xs px-2 py-1 rounded ${r.status === 'open' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${r.status}</span>
                                                    </div>
                                                    <div class="text-sm text-gray-600">${r.campus}</div>
                                                    <div class="text-sm text-gray-500">${r.location}</div>
                                                    <div class="text-xs text-gray-400 mt-1">${r.timestamp} ‚Ä¢ ${r.team}</div>
                                                    ${r.urgent ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded mt-2 inline-block">üö® Urgent</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ============================================
        // QC AUDIT SCREENS (same as before but condensed)
        // ============================================
        function renderSetup() {
            return `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-blue-800 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="goHome()" class="text-2xl mr-3">‚Üê</button>
                            <div>
                                <h1 class="text-xl font-bold">Setup Audit</h1>
                                <p class="text-blue-200 text-sm">Select campus and zones</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Campus *</label>
                            <select id="campus" class="w-full border border-gray-300 rounded-lg p-3 text-lg bg-white">
                                <option value="">Select campus...</option>
                                ${CAMPUSES.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Name *</label>
                            <input type="text" id="auditorName" placeholder="Enter your name" class="w-full border border-gray-300 rounded-lg p-3 text-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mandatory Zones (5)</label>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 space-y-2">
                                ${MANDATORY_ZONE_IDS.map(id => `
                                    <div class="flex items-center">
                                        <span class="text-blue-500 mr-2">‚úì</span>
                                        <span>${ZONES[id].name}</span>
                                        ${!ZONES[id].amberEligible ? '<span class="ml-auto text-xs bg-red-100 text-red-700 px-2 py-1 rounded">‚ö†Ô∏è RED zone</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Optional Zones</label>
                            <div class="space-y-2">
                                ${OPTIONAL_ZONE_IDS.map(id => `
                                    <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 cursor-pointer">
                                        <input type="checkbox" value="${id}" class="optional-zone w-5 h-5 mr-3">
                                        <span class="flex-1">${ZONES[id].name}</span>
                                        ${!ZONES[id].amberEligible ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">‚ö†Ô∏è</span>' : ''}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button onclick="beginAudit()" class="w-full bg-blue-600 text-white py-4 rounded-xl text-lg font-bold">
                            Begin Walkthrough
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAuditOverview() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            return `
                <div class="min-h-screen bg-gray-100 pb-24">
                    <div class="bg-blue-800 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="confirmExit()" class="text-2xl mr-3">‚Üê</button>
                            <div>
                                <h1 class="text-xl font-bold">${state.campus}</h1>
                                <p class="text-blue-200 text-sm">Daily QC Walkthrough</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 border-b">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Progress</span>
                            <span>${Object.keys(state.zoneResults).length} of ${allZones.length} zones</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 transition-all" style="width: ${(Object.keys(state.zoneResults).length / allZones.length) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <h2 class="font-bold text-gray-700 mb-3">Mandatory Zones</h2>
                        <div class="space-y-2 mb-6">
                            ${MANDATORY_ZONE_IDS.map((id, idx) => renderZoneCard(id, idx)).join('')}
                        </div>
                        
                        ${state.selectedOptionalZones.length > 0 ? `
                            <h2 class="font-bold text-gray-700 mb-3">Optional Zones</h2>
                            <div class="space-y-2">
                                ${state.selectedOptionalZones.map((id, idx) => renderZoneCard(id, MANDATORY_ZONE_IDS.length + idx)).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                        ${Object.keys(state.zoneResults).length === allZones.length ? `
                            <button onclick="goToTourReady()" class="w-full bg-green-500 text-white py-4 rounded-xl text-lg font-bold">
                                Continue to Final Question ‚Üí
                            </button>
                        ` : `
                            <button onclick="goToNextIncomplete()" class="w-full bg-blue-600 text-white py-4 rounded-xl text-lg font-bold">
                                ${Object.keys(state.zoneResults).length === 0 ? 'Start First Zone' : 'Continue to Next Zone'} ‚Üí
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function renderZoneCard(zoneId, index) {
            const zone = ZONES[zoneId];
            const results = state.zoneResults[zoneId];
            const isComplete = results !== undefined;
            const defects = isComplete ? countDefects(zoneId) : 0;
            
            return `
                <button onclick="goToZone(${index})" class="w-full ${isComplete ? (defects === 0 ? 'bg-green-50' : 'bg-red-50') : 'bg-white'} p-4 rounded-lg border border-gray-200 flex items-center text-left">
                    <span class="w-8 h-8 rounded-full ${isComplete ? (defects === 0 ? 'bg-green-500' : 'bg-red-500') : 'bg-gray-200'} text-white flex items-center justify-center mr-3 font-bold text-sm">
                        ${isComplete ? (defects === 0 ? '‚úì' : defects) : index + 1}
                    </span>
                    <div class="flex-1">
                        <div class="font-medium">${zone.name}</div>
                        ${zone.description ? `<div class="text-xs text-gray-500">${zone.description}</div>` : ''}
                    </div>
                    ${!zone.amberEligible ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">‚ö†Ô∏è</span>' : ''}
                </button>
            `;
        }

        function renderZone() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            const zoneId = allZones[state.currentZoneIndex];
            const zone = ZONES[zoneId];
            const results = state.zoneResults[zoneId] || {};
            
            return `
                <div class="min-h-screen bg-gray-100 pb-24">
                    <div class="bg-blue-800 text-white p-4">
                        <div class="flex items-center justify-between">
                            <button onclick="goToAuditOverview()" class="text-2xl">‚Üê</button>
                            <div class="text-center">
                                <h1 class="text-lg font-bold">${zone.name}</h1>
                                <p class="text-blue-200 text-sm">Zone ${state.currentZoneIndex + 1} of ${allZones.length}</p>
                            </div>
                            <div class="w-8"></div>
                        </div>
                    </div>
                    
                    <div class="h-1 bg-gray-200">
                        <div class="h-full bg-blue-500" style="width: ${((state.currentZoneIndex + 1) / allZones.length) * 100}%"></div>
                    </div>
                    
                    ${!zone.amberEligible ? `
                        <div class="bg-red-100 border-l-4 border-red-500 p-3 m-4 rounded">
                            <div class="font-medium text-red-800">‚ö†Ô∏è Any defect = RED status</div>
                        </div>
                    ` : ''}
                    
                    <div class="p-4">
                        <div class="space-y-3">
                            ${zone.cleanliness.map((q, idx) => `
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <div class="text-sm mb-3">${idx + 1}. ${q}</div>
                                    <div class="flex gap-2">
                                        <button onclick="setResponse('${zoneId}', ${idx}, 'yes')" class="flex-1 py-2 rounded font-medium ${results[idx] === 'yes' ? 'bg-green-500 text-white' : 'bg-gray-100'}">
                                            ‚úì Yes
                                        </button>
                                        <button onclick="setResponse('${zoneId}', ${idx}, 'no')" class="flex-1 py-2 rounded font-medium ${results[idx] === 'no' ? 'bg-red-500 text-white' : 'bg-gray-100'}">
                                            ‚úó No
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                        <button onclick="completeZone('${zoneId}')" class="w-full py-4 rounded-xl text-lg font-bold ${isZoneComplete(zoneId) ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}" ${isZoneComplete(zoneId) ? '' : 'disabled'}>
                            ${isZoneComplete(zoneId) ? 'Complete Zone ‚Üí Condition Check' : `Answer all (${Object.keys(results).length}/${zone.cleanliness.length})`}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderConditionAlert() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            const zoneId = allZones[state.currentZoneIndex];
            const zone = ZONES[zoneId];
            const alert = state.conditionAlerts.find(a => a.zoneId === zoneId);
            
            return `
                <div class="min-h-screen bg-gray-100 pb-24">
                    <div class="bg-orange-500 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="goToZone(${state.currentZoneIndex})" class="text-2xl mr-3">‚Üê</button>
                            <div>
                                <h1 class="text-xl font-bold">Condition Alert</h1>
                                <p class="text-orange-100 text-sm">${zone.name}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <div class="bg-white rounded-lg p-6 shadow">
                            <div class="text-lg font-medium mb-4">Would you route a tour away from this zone due to building condition?</div>
                            
                            <div class="space-y-3">
                                <button onclick="setConditionAlert('${zoneId}', false)" class="w-full p-4 rounded-lg border-2 ${alert?.hasIssue === false ? 'border-green-500 bg-green-50' : 'border-gray-200'} flex items-center">
                                    <span class="text-2xl mr-3">‚úì</span>
                                    <div class="text-left">
                                        <div class="font-medium">No ‚Äî Condition OK</div>
                                    </div>
                                </button>
                                
                                <button onclick="setConditionAlert('${zoneId}', true)" class="w-full p-4 rounded-lg border-2 ${alert?.hasIssue === true ? 'border-red-500 bg-red-50' : 'border-gray-200'} flex items-center">
                                    <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                                    <div class="text-left">
                                        <div class="font-medium">Yes ‚Äî Condition Issue</div>
                                        <div class="text-sm text-gray-500">Photo required</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        ${alert?.hasIssue === true ? `
                            <div class="bg-white rounded-lg p-4 shadow slide-up">
                                <!-- Photo -->
                                <div class="mb-4">
                                    ${alert.photo ? `
                                        <div class="relative">
                                            <img src="${alert.photo}" alt="Condition issue" class="w-full rounded-lg">
                                            <button onclick="takeConditionPhoto('${zoneId}')" class="absolute bottom-2 right-2 bg-white px-3 py-1 rounded-lg text-sm shadow">üîÑ Retake</button>
                                        </div>
                                    ` : `
                                        <button onclick="takeConditionPhoto('${zoneId}')" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                            <div class="text-4xl mb-2">üì∑</div>
                                            <div class="font-medium">Tap to Take Photo</div>
                                        </button>
                                    `}
                                </div>
                                
                                <label class="block text-sm font-medium text-gray-700 mb-2">Describe the issue *</label>
                                <input type="text" id="conditionNote" maxlength="100" placeholder="e.g., Hole in drywall near door" class="w-full border border-gray-300 rounded-lg p-3" value="${alert.note || ''}" oninput="updateConditionNote(this.value)">
                                <div class="text-xs text-gray-400 mt-1 text-right">${(alert.note || '').length}/100</div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="text-sm text-blue-800">
                                Condition alerts route to B&G and do NOT affect cleanliness score.
                            </div>
                        </div>
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                        <button onclick="finishZone()" class="w-full py-4 rounded-xl text-lg font-bold ${canCompleteCondition(zoneId) ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500'}" ${canCompleteCondition(zoneId) ? '' : 'disabled'}>
                            ${state.currentZoneIndex < allZones.length - 1 ? 'Next Zone ‚Üí' : 'Finish Walkthrough ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTourReady() {
            return `
                <div class="min-h-screen bg-gray-100 pb-24">
                    <div class="bg-blue-800 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="goToAuditOverview()" class="text-2xl mr-3">‚Üê</button>
                            <h1 class="text-xl font-bold">Final Question</h1>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="bg-white rounded-lg p-6 shadow">
                            <div class="text-lg font-medium mb-4">Based on your entire walkthrough, could a parent tour happen right now?</div>
                            
                            <div class="space-y-3">
                                <button onclick="setTourReady('yes')" class="w-full p-4 rounded-lg border-2 ${state.tourReady === 'yes' ? 'border-green-500 bg-green-50' : 'border-gray-200'} flex items-center">
                                    <span class="text-2xl mr-3">‚úì</span>
                                    <div class="font-medium">Yes ‚Äî Tour Ready</div>
                                </button>
                                
                                <button onclick="setTourReady('no')" class="w-full p-4 rounded-lg border-2 ${state.tourReady === 'no' ? 'border-red-500 bg-red-50' : 'border-gray-200'} flex items-center">
                                    <span class="text-2xl mr-3">‚úó</span>
                                    <div>
                                        <div class="font-medium">No ‚Äî Not Tour Ready</div>
                                        <div class="text-sm text-red-600">‚ö†Ô∏è Automatic RED</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                        <button onclick="goToSummary()" class="w-full py-4 rounded-xl text-lg font-bold ${state.tourReady !== null ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}" ${state.tourReady !== null ? '' : 'disabled'}>
                            Review Summary ‚Üí
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSummary() {
            const status = calculateStatus();
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            const totalDefects = getTotalDefects();
            const duration = Math.round((Date.now() - state.startTime) / 60000);
            
            return `
                <div class="min-h-screen bg-gray-100 pb-24">
                    <div class="${status === 'GREEN' ? 'bg-green-500' : status === 'AMBER' ? 'bg-yellow-500' : 'bg-red-500'} text-white p-6 text-center">
                        <div class="text-5xl mb-2">${status === 'GREEN' ? '‚úì' : status === 'AMBER' ? '‚ö†Ô∏è' : '‚úó'}</div>
                        <div class="text-3xl font-bold">${status}</div>
                        <div class="opacity-90">${state.campus}</div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white p-3 rounded-lg shadow text-center">
                                <div class="text-xl font-bold">${allZones.length}</div>
                                <div class="text-xs text-gray-500">Zones</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow text-center">
                                <div class="text-xl font-bold ${totalDefects > 0 ? 'text-red-500' : 'text-green-500'}">${totalDefects}</div>
                                <div class="text-xs text-gray-500">Defects</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow text-center">
                                <div class="text-xl font-bold">${duration}m</div>
                                <div class="text-xs text-gray-500">Duration</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow divide-y">
                            ${allZones.map(zoneId => {
                                const zone = ZONES[zoneId];
                                const defects = countDefects(zoneId);
                                return `
                                    <div class="p-3 flex items-center">
                                        <span class="w-7 h-7 rounded-full ${defects === 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} flex items-center justify-center mr-3 font-bold text-sm">
                                            ${defects === 0 ? '‚úì' : defects}
                                        </span>
                                        <span class="flex-1 text-sm">${zone.name}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${state.conditionAlerts.filter(a => a.hasIssue).length > 0 ? `
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <div class="font-bold text-orange-800 mb-1">‚ö†Ô∏è ${state.conditionAlerts.filter(a => a.hasIssue).length} Condition Alert(s)</div>
                                <div class="text-sm text-orange-700">Will be routed to B&G</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                        <button onclick="submitAudit()" class="w-full bg-blue-600 text-white py-4 rounded-xl text-lg font-bold">
                            ‚úì Submit Audit
                        </button>
                    </div>
                </div>
            `;
        }

        function renderComplete() {
            const status = calculateStatus();
            return `
                <div class="min-h-screen ${status === 'GREEN' ? 'bg-green-500' : status === 'AMBER' ? 'bg-yellow-500' : 'bg-red-500'} flex flex-col items-center justify-center p-8 text-white text-center">
                    <div class="text-8xl mb-6">‚úÖ</div>
                    <h1 class="text-3xl font-bold mb-2">Audit Submitted!</h1>
                    <div class="text-5xl font-bold my-4">${status}</div>
                    <p class="opacity-90 mb-8">${state.campus}</p>
                    <button onclick="goHome()" class="bg-white text-gray-800 px-8 py-3 rounded-lg font-bold">Done</button>
                </div>
            `;
        }

        function renderHistory() {
            const audits = getAudits().reverse();
            return `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-blue-800 text-white p-4">
                        <div class="flex items-center">
                            <button onclick="goHome()" class="text-2xl mr-3">‚Üê</button>
                            <h1 class="text-xl font-bold">Audit History</h1>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        ${audits.length === 0 ? `
                            <div class="text-center py-12 text-gray-400">
                                <div class="text-5xl mb-4">üìã</div>
                                <p>No audits yet</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${audits.map(a => `
                                    <div class="bg-white rounded-lg p-4 shadow">
                                        <div class="flex items-center">
                                            <span class="text-2xl mr-3">${a.status === 'GREEN' ? 'üü¢' : a.status === 'AMBER' ? 'üü°' : 'üî¥'}</span>
                                            <div class="flex-1">
                                                <div class="font-bold">${a.campus}</div>
                                                <div class="text-sm text-gray-500">${a.date} ‚Ä¢ ${a.auditor}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold ${a.status === 'GREEN' ? 'text-green-600' : a.status === 'AMBER' ? 'text-yellow-600' : 'text-red-600'}">${a.status}</div>
                                                <div class="text-sm text-gray-500">${a.defects} defect${a.defects !== 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        function attachEventListeners() {}

        function goHome() {
            state = {
                screen: 'home',
                campus: '', auditorName: '', startTime: null,
                selectedOptionalZones: [], currentZoneIndex: 0,
                zoneResults: {}, conditionAlerts: [], tourReady: null,
                reportCampus: '', reportPhoto: null, reportCategory: null,
                reportLocation: '', reportNote: '', reportUrgent: false
            };
            render();
        }

        function goToHistory() { state.screen = 'history'; render(); }
        function goToReportsList() { state.screen = 'reports_list'; render(); }
        function startAudit() { state.screen = 'setup'; render(); }
        function startReport() { state.screen = 'report_start'; render(); }

        function beginAudit() {
            const campus = document.getElementById('campus').value;
            const auditorName = document.getElementById('auditorName').value;
            if (!campus || !auditorName) { alert('Please select campus and enter name'); return; }
            state.campus = campus;
            state.auditorName = auditorName;
            state.selectedOptionalZones = Array.from(document.querySelectorAll('.optional-zone:checked')).map(el => el.value);
            state.startTime = Date.now();
            state.screen = 'audit';
            render();
        }

        function goToAuditOverview() { state.screen = 'audit'; render(); }

        function goToNextIncomplete() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            for (let i = 0; i < allZones.length; i++) {
                if (!state.zoneResults[allZones[i]]) {
                    state.currentZoneIndex = i;
                    state.screen = 'zone';
                    render();
                    return;
                }
            }
        }

        function goToZone(index) { state.currentZoneIndex = index; state.screen = 'zone'; render(); }

        function setResponse(zoneId, questionIndex, value) {
            if (!state.zoneResults[zoneId]) state.zoneResults[zoneId] = {};
            state.zoneResults[zoneId][questionIndex] = value;
            render();
        }

        function isZoneComplete(zoneId) {
            const zone = ZONES[zoneId];
            const results = state.zoneResults[zoneId] || {};
            return Object.keys(results).length === zone.cleanliness.length;
        }

        function completeZone(zoneId) {
            if (isZoneComplete(zoneId)) { state.screen = 'condition'; render(); }
        }

        function setConditionAlert(zoneId, hasIssue) {
            const idx = state.conditionAlerts.findIndex(a => a.zoneId === zoneId);
            if (idx >= 0) {
                if (hasIssue) state.conditionAlerts[idx].hasIssue = true;
                else state.conditionAlerts.splice(idx, 1);
            } else if (hasIssue) {
                state.conditionAlerts.push({ zoneId, hasIssue: true, note: '', photo: null });
            } else {
                state.conditionAlerts.push({ zoneId, hasIssue: false, note: '', photo: null });
            }
            render();
        }

        function takeConditionPhoto(zoneId) {
            openCamera((imageData) => {
                const alert = state.conditionAlerts.find(a => a.zoneId === zoneId);
                if (alert) alert.photo = imageData;
                render();
            }, 'Condition Issue Photo');
        }

        function updateConditionNote(note) {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            const zoneId = allZones[state.currentZoneIndex];
            const alert = state.conditionAlerts.find(a => a.zoneId === zoneId);
            if (alert) alert.note = note;
        }

        function canCompleteCondition(zoneId) {
            const alert = state.conditionAlerts.find(a => a.zoneId === zoneId);
            if (!alert || alert.hasIssue === false) return true;
            return alert.hasIssue && alert.photo && alert.note && alert.note.length > 0;
        }

        function finishZone() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            if (state.currentZoneIndex < allZones.length - 1) {
                state.currentZoneIndex++;
                state.screen = 'zone';
            } else {
                state.screen = 'audit';
            }
            render();
        }

        function goToTourReady() { state.screen = 'tourready'; render(); }
        function setTourReady(value) { state.tourReady = value; render(); }
        function goToSummary() { state.screen = 'summary'; render(); }
        function confirmExit() { if (confirm('Exit? Progress will be lost.')) goHome(); }

        function submitAudit() {
            const allZones = [...MANDATORY_ZONE_IDS, ...state.selectedOptionalZones];
            saveAudit({
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                campus: state.campus,
                auditor: state.auditorName,
                status: calculateStatus(),
                defects: getTotalDefects(),
                zones: allZones.length,
                duration: Math.round((Date.now() - state.startTime) / 60000),
                tourReady: state.tourReady === 'yes',
                conditionAlerts: state.conditionAlerts.filter(a => a.hasIssue).length,
                zoneResults: state.zoneResults,
                conditionAlertDetails: state.conditionAlerts.filter(a => a.hasIssue)
            });
            state.screen = 'complete';
            render();
        }

        // See It Report It handlers
        function openReportCamera() {
            const campus = document.getElementById('reportCampus')?.value;
            if (!campus) { alert('Please select a campus first'); return; }
            state.reportCampus = campus;
            openCamera((imageData) => {
                state.reportPhoto = imageData;
                state.screen = 'report_photo';
                render();
            }, 'Capture Issue');
        }

        function retakePhoto() {
            openCamera((imageData) => {
                state.reportPhoto = imageData;
                render();
            }, 'Capture Issue');
        }

        function setReportCategory(catId) { state.reportCategory = catId; render(); }
        function toggleUrgent() { state.reportUrgent = !state.reportUrgent; render(); }

        function canSubmitReport() {
            const location = document.getElementById('reportLocation')?.value || state.reportLocation;
            return state.reportPhoto && state.reportCategory && location;
        }

        function submitReport() {
            state.reportLocation = document.getElementById('reportLocation')?.value || '';
            state.reportNote = document.getElementById('reportNote')?.value || '';
            
            const cat = ISSUE_CATEGORIES.find(c => c.id === state.reportCategory);
            saveReport({
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                campus: state.reportCampus,
                photo: state.reportPhoto,
                category: state.reportCategory,
                location: state.reportLocation,
                note: state.reportNote,
                urgent: state.reportUrgent,
                team: cat?.team || 'Facilities',
                status: 'open'
            });
            state.screen = 'report_complete';
            render();
        }

        // Initialize
        render();
    </script>
    
    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 z-50 hidden" style="background: black;">
        <video id="cameraFeed" autoplay playsinline class="w-full h-full object-cover"></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>
        <div class="absolute inset-0 flex flex-col">
            <div class="bg-black/50 p-4 flex justify-between items-center">
                <button onclick="closeCamera()" class="text-white text-lg">‚úï Cancel</button>
                <span class="text-white text-sm" id="cameraLabel">üì∑ Take Photo</span>
            </div>
            <div class="flex-1"></div>
            <div class="bg-black/50 p-6 flex justify-center">
                <button onclick="capturePhoto()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center bg-white/20 active:bg-white/40">
                    <div class="w-16 h-16 rounded-full bg-white"></div>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
